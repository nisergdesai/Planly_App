<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Add jQuery here -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .left-column, .right-column {
            flex: 1;
            min-width: 45%;
        }
        .card {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }
        .file-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        .summarize-button {
            align-self: flex-start;
            padding: 6px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .summarize-button:hover {
            background-color: #0056b3;
        }
        .back-button {
            margin-top: 10px;
            padding: 6px 12px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .back-button:hover {
            background-color: #c82333;
        }
    </style>
    <script>
        let originalCardContent = {}; 
        let fetchControllers = {}; 

        function summarizeFile(event, fileId, fileName, fileMimeType, fileSource, cardId) {
            event.preventDefault();

            let cardElement = document.getElementById(cardId);
            if (!originalCardContent[cardId]) {
                originalCardContent[cardId] = cardElement.innerHTML;
            }

            if (fetchControllers[cardId]) {
                fetchControllers[cardId].abort(); 
            }
            fetchControllers[cardId] = new AbortController();
            let signal = fetchControllers[cardId].signal;

            cardElement.innerHTML = `
                <p>Summarizing...</p>
                <button class="back-button" onclick="restoreContent('${cardId}', true)">Cancel</button>
            `;

            let formData = new FormData();
            formData.append("file_id", String(fileId));
            formData.append("file_name", String(fileName));
            formData.append("file_mime_type", fileMimeType);
            formData.append("file_source", fileSource);

            fetch('/summarize', {
                method: 'POST',
                body: formData,
                signal: signal 
            })
            .then(response => response.json())
            .then(data => {
                if (!fetchControllers[cardId]) return; 

                if (data.summary) {
                    cardElement.innerHTML = `
                        <p>${data.summary}</p>
                        <button class="back-button" onclick="restoreContent('${cardId}', false)">Back</button>
                    `;
                } else {
                    cardElement.innerHTML = `<p>Error: Unable to summarize.</p>`;
                }
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    console.log("Fetch request canceled.");
                } else {
                    console.error('Error:', error);
                    cardElement.innerHTML = `<p>Error: Something went wrong.</p>`;
                }
            })
            .finally(() => {
                delete fetchControllers[cardId];
            });
        }

        function restoreContent(cardId, isCancel) {
            if (originalCardContent[cardId]) {
                document.getElementById(cardId).innerHTML = originalCardContent[cardId];
                delete originalCardContent[cardId];

                if (isCancel && fetchControllers[cardId]) {
                    fetchControllers[cardId].abort();
                    delete fetchControllers[cardId];
                }
            }
        }

        function updateSummarizeButton() {
            let checkboxes = document.querySelectorAll('.email-checkbox');
            let selected = Array.from(checkboxes).some(checkbox => checkbox.checked);
            document.getElementById('summarize-emails-button').style.display = selected ? 'block' : 'none';
        }

        function summarizeSelectedEmails() {
            let selectedEmails = Array.from(document.querySelectorAll('.email-checkbox:checked')).map(cb => cb.value);
            if (selectedEmails.length === 0) return;

            document.getElementById('gmail-card').innerHTML = "<p>Summarizing...</p>";

            fetch('/summarize_emails', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email_ids: selectedEmails })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('gmail-card').innerHTML = `<h2>Gmail Summary</h2><p>${data.summary}</p>`;
            })
            .catch(error => console.error('Error:', error));
        }

    </script>

</head>
<body>

    <h1>Dashboard</h1>
    
    <div class="container">
        <!-- Left Column -->
        <div class="left-column">
            <div class="card" id="gmail-card">
                <h2>Gmail Emails</h2>
            
                <button id="connect-gmail-btn" class="connect-button">Connect Gmail</button>
                <p id="gmail-status" class="status">Not Connected</p>
            
                <!-- Choose Date Input (Initially Hidden) -->
                <div id="gmail-date-selection" style="display: none;">
                    <label for="gmail-date">Choose Gmail Date:</label>
                    <input type="date" id="gmail-date">
                    <button onclick="chooseGmailDate()">Set Gmail Date</button>
                </div>
            
                <ul id="email-list"></ul> <!-- Placeholder for Gmail emails -->
                <button id="summarize-emails-button" class="summarize-button" style="display:none;" onclick="summarizeSelectedEmails()">Summarize Selected</button>
            </div>
            
            
            <script>
                let originalGmailContent = ""; 
                let gmailFetchController = null; 
            
                function updateSummarizeButton() {
                    let checkboxes = document.querySelectorAll('.email-checkbox');
                    let selected = Array.from(checkboxes).some(checkbox => checkbox.checked);
                    document.getElementById('summarize-emails-button').style.display = selected ? 'block' : 'none';
                }
            
                function summarizeSelectedEmails() {
                    let selectedEmails = Array.from(document.querySelectorAll('.email-checkbox:checked')).map(cb => cb.value);
                    if (selectedEmails.length === 0) return;
            
                    let gmailCard = document.getElementById("gmail-card");
            
                    // Save original content
                    if (!originalGmailContent) {
                        originalGmailContent = gmailCard.innerHTML;
                    }
            
                    // Abort any ongoing fetch request
                    if (gmailFetchController) {
                        gmailFetchController.abort();
                    }
                    gmailFetchController = new AbortController();
                    let signal = gmailFetchController.signal;
            
                    gmailCard.innerHTML = `
                        <p>Summarizing selected emails...</p>
                        <button class="back-button" onclick="restoreGmailContent(true)">Cancel</button>
                    `;
            
                    fetch('/summarize_emails', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email_ids: selectedEmails }),
                        signal: signal
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!gmailFetchController) return;
            
                        if (data.summary) {
                            gmailCard.innerHTML = `
                                <h2>Gmail Summary</h2>
                                <p>${data.summary}</p>
                                <button class="back-button" onclick="restoreGmailContent(false)">Back</button>
                            `;
                        } else {
                            gmailCard.innerHTML = `<p>Error: Unable to summarize.</p>`;
                        }
                    })
                    .catch(error => {
                        if (error.name === 'AbortError') {
                            console.log("Summarization request canceled.");
                        } else {
                            console.error('Error:', error);
                            gmailCard.innerHTML = `<p>Error: Something went wrong.</p>`;
                        }
                    })
                    .finally(() => {
                        gmailFetchController = null;
                    });
                }
            
                function restoreGmailContent(isCancel) {
                    let gmailCard = document.getElementById("gmail-card");
            
                    if (originalGmailContent) {
                        gmailCard.innerHTML = originalGmailContent;
                        originalGmailContent = "";
                    }
            
                    if (isCancel && gmailFetchController) {
                        gmailFetchController.abort();
                        gmailFetchController = null;
                    }
                }
            </script>            

            <div class="card">
                <h2>Active Courses</h2>
                <div id="courses">
                    {% for course in courses %}
                        <div class="course" onclick="toggleCourse('{{ course.id }}')">
                            {{ course.name }}
                            <div id="buttons-{{ course.id }}" class="hidden">
                                <button onclick="fetchContent('{{ course.id }}', 'syllabus')">Syllabus</button>
                                <button onclick="fetchContent('{{ course.id }}', 'upcoming_assignments')">Upcoming Assignments</button>
                                <button onclick="fetchContent('{{ course.id }}', 'recent_announcements')">Recent Announcements</button>
                                <div id="content-{{ course.id }}" class="content hidden"></div>
                            </div>
                        </div>
                    {% endfor %}
                </div>                               
            </div>
        </div>

        <!-- Right Column -->
        <div class="right-column">
            <div class="card" id="google-drive-card">
                <h2>Google Drive Files</h2>
            
                <!-- Connect Google Drive Button -->
                <button id="connect-drive-btn" class="connect-button">Connect Google Drive</button>
                <p id="drive-status" class="status">Not Connected</p>
            
                <!-- Choose Date Input (Initially Hidden) -->
                <div id="drive-date-selection" style="display: none;">
                    <label for="drive-date">Choose Google Drive Date:</label>
                    <input type="date" id="drive-date">
                    <button onclick="chooseDriveDate()">Set Drive Date</button>
                </div>
            
                <ul id="google-drive-files"></ul> <!-- Placeholder for Drive Files -->
            </div>
            
            <div class="card" id="microsoft-card">
                <h2>Microsoft (OneDrive & Outlook)</h2>
                <button id="connect-microsoft-btn" class="connect-button">Connect Microsoft</button>
                <p id="microsoft-status" class="status">Not Connected</p>
                <div id="microsoft-auth-container" style="display: none;">
                    <p>Enter this code: <strong id="user-code"></strong></p>
                </div>    
                <button id="check-status-btn" class="connect-button" style="display: none;">Check Status</button>    
                    <!-- Choose Date Inputs (Initially Hidden) -->
                    <div id="date-selection" style="display: none;">
                        <label for="onedrive-date">Choose OneDrive Date:</label>
                        <input type="date" id="onedrive-date">
                        <button onclick="chooseDate('onedrive')">Set OneDrive Date</button>
                
                        <label for="outlook-date">Choose Outlook Date:</label>
                        <input type="date" id="outlook-date">
                        <button onclick="chooseDate('outlook')">Set Outlook Date</button>
                    </div>
                <div class="card">
                    <h2>Outlook Summary</h2>
                    <div id="outlook-summary">No data yet.</div> <!-- Placeholder -->
                </div>
            
                <div class="card" id="onedrive-card">
                    <h2>OneDrive Files</h2>
                    <ul id="onedrive-files"></ul> <!-- Placeholder -->
                </div>
            </div>

        <script>
            $(document).ready(function() {
                $("#connect-drive-btn").click(function() {
                    $.ajax({
                        url: "/connect_google_drive",
                        type: "POST",
                        success: function(response) {
                            if (response.status === "success") {
                                $("#drive-status").text("Connected to Google Drive ✅").css("color", "green");
                                $("#connect-drive-btn").hide();

                                // Show date selection fields
                                $("#drive-date-selection").show();

                                // Update the file list
                                let filesList = $("#google-drive-files");
                                filesList.empty(); // Clear previous content

                                response.files.forEach(file => {
                                    let listItem = `
                                        <li class="file-container">
                                            <a href="https://drive.google.com/file/d/${file.id}" target="_blank">${file.name}</a>
                                            <button class="summarize-button" 
                                                onclick="summarizeFile(event, '${file.id}', '${file.name}', '${file.mimeType}', 'google_drive', 'google-drive-card')">
                                                Summarize
                                            </button>
                                        </li>
                                    `;
                                    filesList.append(listItem);
                                });
                            } else {
                                $("#drive-status").text("Connection Failed ❌").css("color", "red");
                            }
                        },
                        error: function() {
                            $("#drive-status").text("Connection Error ❌").css("color", "red");
                        }
                    });
                });
            });
            $(document).ready(function() {
                $("#connect-gmail-btn").click(function() {
                    $("#gmail-status").text("Fetching metadata... ⏳").css("color", "orange");

                    $.ajax({
                        url: "/connect_gmail",  // Endpoint for Gmail authentication
                        type: "POST",
                        success: function(response) {
                            if (response.status === "success") {
                                $("#gmail-status").text("Connected to Gmail ✅").css("color", "green");
                                $("#connect-gmail-btn").hide();
                                // Show the date selection fields
                                $("#gmail-date-selection").show();

                                // Update the email list
                                let emails = response.emails;
                                let emailListHtml = "";
                                emails.forEach(email => {
                                    emailListHtml += `<li>
                                                        <input type="checkbox" class="email-checkbox" value="${email.id}" onchange="updateSummarizeButton()">
                                                        <a href="${email.link}" target="_blank">${email.sender} ${email.subject} (${email.date})</a>
                                                    </li>`;
                                });
                                $("#email-list").html(emailListHtml); // Update the Gmail email list
                            } else {
                                $("#gmail-status").text("Connection Failed ❌").css("color", "red");
                            }
                        },
                        error: function() {
                            $("#gmail-status").text("Connection Error ❌").css("color", "red");
                        }
                    });
                });
            });
            $(document).ready(function() {
                $("#connect-microsoft-btn").click(function() {
                    $("#microsoft-status").text("Checking connection... ⏳").css("color", "orange");

                    $.ajax({
                        url: "/fetch_code",
                        type: "POST",
                        success: function(response) {
                            console.log(response);  

                            if (response.status === "pending") {
                                if (response.user_code) {
                                    $("#microsoft-status").text("User authentication required! ⚠️").css("color", "green");
                                    $("#microsoft-auth-container").show();
                                    $("#user-code").text(response.user_code);
                                    $("#check-status-btn")
                                        .text(`Authenticate`)
                                        .css("display", "inline-block")
                                        .off("click")
                                        .click(function() {
                                            window.open(response.verification_url, "_blank"); 
                                            fetchMicrosoftStatus(); 
                                        });
                                }
                            } else if (response.status === "success") {
                                fetchMicrosoftStatus(); 
                            } else {
                                $("#microsoft-status").text("Error fetching data ❌").css("color", "red");
                            }
                        },
                        error: function() {
                            $("#microsoft-status").text("Connection Error ❌").css("color", "red");
                        }
                    });
                });

                function fetchMicrosoftStatus() {
                    $("#microsoft-status").text("Fetching data from OneDrive & Outlook... ⏳").css("color", "orange");

                    $.ajax({
                        url: "/fetch_onedrive_outlook",
                        type: "POST",
                        success: function(response) {
                            console.log(response);

                            if (response.status === "pending") {
                                $("#microsoft-status").text("Connected ✅").css("color", "green");

                                // Hide authentication elements
                                $("#connect-microsoft-btn").hide();
                                $("#microsoft-auth-container").hide();
                                $("#check-status-btn").hide();

                                // Show date selection fields
                                $("#date-selection").show();

                                // Update Outlook Summary
                                $("#outlook-summary").html(response.outlooks || "No emails found.");

                                // Update OneDrive Files
                                let filesList = $("#onedrive-files");
                                filesList.empty();  

                                response.o_files.forEach(file => {
                                    let listItem = `
                                        <li class="file-container">
                                            ${file[0]} (ID: ${file[1]})
                                            <button class="summarize-button" 
                                                onclick="summarizeFile(event, '${file[1]}', '${file[0]}', '', 'onedrive', 'onedrive-card')">
                                                Summarize
                                            </button>
                                        </li>
                                    `;
                                    filesList.append(listItem);
                                });

                            } else {
                                $("#microsoft-status").text("Error fetching data ❌").css("color", "red");
                            }
                        },
                        error: function() {
                            $("#microsoft-status").text("Error retrieving data ❌").css("color", "red");
                        }
                    });
                }
            });
            function chooseDate(type) {
                let selectedDate = type === 'onedrive' ? $("#onedrive-date").val() : $("#outlook-date").val();

                if (selectedDate) {
                    let dateDifference = calculateDateDifference(selectedDate);
                    
                    // Determine the target element for displaying the loading message
                    let targetElement = type === 'onedrive' ? $("#onedrive-files") : $("#outlook-summary");

                    // Show a loading message in the respective card
                    targetElement.html(`<p style="color: orange;">Fetching ${type.charAt(0).toUpperCase() + type.slice(1)} data... ⏳</p>`);

                    $.ajax({
                        url: "/fetch_onedrive_outlook",
                        type: "POST",
                        data: {
                            cutoff_days: dateDifference,
                            type: type  // Pass 'onedrive' or 'outlook'
                        },
                        success: function(response) {
                            console.log(response); // Debugging

                            if (type === "outlook") {
                                let outlookData = response.outlooks || "<p style='color: gray;'>No recent emails found.</p>";
                                targetElement.html(outlookData);
                            } else if (type === "onedrive") {
                                let filesList = $("#onedrive-files");
                                filesList.empty(); // Clear previous content

                                if (response.o_files && response.o_files.length > 0) {
                                    response.o_files.forEach(file => {
                                        let listItem = `
                                            <li class="file-container">
                                                ${file[0]} (ID: ${file[1]})
                                                <button class="summarize-button" 
                                                    onclick="summarizeFile(event, '${file[1]}', '${file[0]}', '', 'onedrive', 'onedrive-card')">
                                                    Summarize
                                                </button>
                                            </li>
                                        `;
                                        filesList.append(listItem);
                                    });
                                } else {
                                    filesList.append("<li style='color: gray;'>No recent OneDrive files found.</li>");
                                }
                            }
                        },
                        error: function() {
                            console.error("Error retrieving data");
                            targetElement.html(`<p style="color: red;">Error retrieving ${type} data ❌</p>`);
                        }
                    });
                }
            }
            // Function to handle date selection for Google Drive
            function chooseDriveDate() {
                let selectedDate = $("#drive-date").val();

                if (selectedDate) {
                    let dateDifference = calculateDateDifference(selectedDate);

                    // Show a loading message
                    $("#google-drive-files").html(`<p style="color: orange;">Fetching Google Drive data... ⏳</p>`);

                    $.ajax({
                        url: "/connect_google_drive",
                        type: "POST",
                        data: {
                            num_days: dateDifference
                        },
                        success: function(response) {
                            console.log(response); // Debugging

                            let filesList = $("#google-drive-files");
                            filesList.empty(); // Clear previous content

                            if (response.files && response.files.length > 0) {
                                response.files.forEach(file => {
                                    let listItem = `
                                        <li class="file-container">
                                            <a href="https://drive.google.com/file/d/${file.id}" target="_blank">${file.name}</a>
                                            <button class="summarize-button" 
                                                onclick="summarizeFile(event, '${file.id}', '${file.name}', '${file.mimeType}', 'google_drive', 'google-drive-card')">
                                                Summarize
                                            </button>
                                        </li>
                                    `;
                                    filesList.append(listItem);
                                });
                            } else {
                                filesList.append("<li style='color: purple;'>No recent Google Drive files found.</li>");
                            }
                        },
                        error: function() {
                            console.error("Error retrieving data");
                            $("#google-drive-files").html(`<p style="color: red;">Error retrieving Google Drive data ❌</p>`);
                        }
                    });
                }
            }

            function toggleCourse(courseId) {
                $("#buttons-" + courseId).toggleClass("hidden");
            }

            function fetchContent(courseId, contentType) {
                $.ajax({
                    url: "/course_details",
                    type: "POST",
                    contentType: "application/json",  // ✅ Specify JSON content type
                    data: JSON.stringify({ course_id: courseId, content_type: contentType }),
                    success: function (data) {
                        if (data.content) {
                            // Injecting the HTML content directly without wrapping it in <p> tags.
                            $("#content-" + courseId).html(data.content).removeClass("hidden");
                        } else {
                            $("#content-" + courseId).html("<p>Error fetching data.</p>").removeClass("hidden");
                        }
                    },
                    error: function () {
                        $("#content-" + courseId).html("<p>Failed to fetch data.</p>").removeClass("hidden");
                    }
                });
            }


            function chooseGmailDate() {
                let selectedDate = $("#gmail-date").val();

                if (selectedDate) {
                    let dateDifference = calculateDateDifference(selectedDate);

                    // Show a loading message while fetching
                    $("#email-list").html(`<p style="color: orange;">Fetching Gmail data... ⏳</p>`);

                    $.ajax({
                        url: "/connect_gmail",
                        type: "POST",
                        data: {
                            num_days: dateDifference
                        },
                        success: function(response) {
                            console.log(response); // Debugging

                            let emailList = $("#email-list");
                            emailList.empty(); // Clear previous content

                            if (response.emails && response.emails.length > 0) {
                                response.emails.forEach(email => {
                                    let listItem = `
                                        <li>
                                            <input type="checkbox" class="email-checkbox" value="${email.id}" onchange="updateSummarizeButton()">
                                            <a href="${email.link}" target="_blank">${email.sender} ${email.subject} (${email.date})</a>
                                        </li>
                                    `;
                                    emailList.append(listItem);
                                });
                            } else {
                                emailList.append("<li style='color: gray;'>No recent Gmail emails found.</li>");
                            }
                        },
                        error: function() {
                            console.error("Error retrieving data");
                            $("#email-list").html(`<p style="color: red;">Error retrieving Gmail data ❌</p>`);
                        }
                    });
                }
            }

            function calculateDateDifference(selectedDate) {
                let today = new Date();
                let chosenDate = new Date(selectedDate);
                let timeDiff = today - chosenDate;  // Difference in milliseconds
                let dayDiff = Math.max(Math.floor(timeDiff / (1000 * 3600 * 24)), 0);  // Ensure non-negative
                return dayDiff;
            }


        </script>        

</body>
</html>



