<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to right, #005A8D, #7A4E2D); /* Blue & Earthy mix */
            color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            transition: all 0.3s ease-in-out;
        }

        /* Logo Container */
        .logo-container {
            display: flex;
            gap: 25px;
            justify-content: center;
            flex-wrap: wrap;
            transition: all 0.5s ease-in-out;
            padding: 20px;
            position: relative; /* To ensure proper layering with other elements */
            z-index: 10; /* Keep logos on top */
        }

        /* Logo Styling */
        .logo {
            background: rgba(255, 255, 255, 0.15);
            padding: 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
        }

        .logo img {
            width: 70px;
            height: 70px;
            transition: all 0.3s ease;
        }

        /* Shrink Effect (for compact navigation) */
        .logo-container.shrink {
            position: fixed;
            top: 10px;
            left: 10px;
            transform: none;
            justify-content: flex-start;
            padding: 10px;
            border-radius: 8px;
        }

        .logo-container.shrink .logo img {
            width: 40px;
            height: 40px;
        }

        /* Course Container (CSS Grid Layout) */
        .course-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Dynamic grid */
            gap: 20px;
            width: 100%;
            padding: 25px;
            box-sizing: border-box;
            overflow-y: auto;
            align-items: start; /* Make sure cards don't stretch to match height */
        }

        /* Course Cards */
        .course-card {
            background: rgba(210, 180, 140, 0.15);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transition: box-shadow 0.3s ease-in-out, background 0.3s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            margin-bottom: 0; /* Remove margin-bottom, let the grid handle spacing */
        }


        .course-card:hover {
            background: rgba(210, 180, 140, 0.25);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        /* Content Container */
        .container {
            display: none;
            padding: 25px;
            width: 85%;
            max-width: 950px;
            border-radius: 12px;
            text-align: justify;
            overflow-y: auto;
            max-height: 80vh;
            margin-top: 80px; /* Added margin-top for more space between logos and cards */
        }

        /* Cards */
        .card {
            background: rgba(210, 180, 140, 0.15); /* Lighter earthy tone to match the theme */
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px; /* Increased margin for more space between cards */
            transition: box-shadow 0.3s ease-in-out, background 0.3s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border for depth */
            z-index: 5; /* Ensure cards stay behind logos */
            max-width: 100%; /* Prevent overflow */
        }

        /* Cards on Hover (No scaling, just a glow effect) */
        .card:hover {
            background: rgba(210, 180, 140, 0.2); /* Slightly deeper earthy tone */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); /* Soft shadow for emphasis */
        }

        /* Buttons */
        .button {
            background: linear-gradient(to right, #9ac8e3, #99b8d0); /* Blue & Earthy gradient */
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            width: auto;
            text-align: center;
            margin-top: 10px;
            transition: all 0.3s ease-in-out; /* Smooth transition for all changes */
        }

        .button:hover {
            background: linear-gradient(to right, #99b8d0, #9ac8e3); /* Slight change to gradient on hover */
            box-shadow: 0 0 15px rgba(154, 200, 227, 0.8), 0 0 30px rgba(153, 184, 208, 0.6); /* Glowing effect */
        }


        /* Scrollbar (for better experience) */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1); /* Slight beige tint */
        }

        ::-webkit-scrollbar-thumb {
            background: #8C6F43; /* Earthy brown tone */
            border-radius: 5px;
        }

        .search-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
        }

        #search-input {
            width: 300px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        #service-filter {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        #search-results {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            transition: background 0.3s;
        }

        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .search-result-item a {
            color: #f5f5f5;
            text-decoration: none;
            font-weight: bold;
        }

        .search-result-item a:hover {
            text-decoration: underline;
        }


    </style>

    <script>
        let originalCardContent = {}; 
        let fetchControllers = {}; 

        function summarizeFile(event, fileId, fileName, fileMimeType, fileSource, cardId) {
            event.preventDefault();

            let cardElement = document.getElementById(cardId);
            if (!originalCardContent[cardId]) {
                originalCardContent[cardId] = cardElement.innerHTML;
            }

            if (fetchControllers[cardId]) {
                fetchControllers[cardId].abort(); 
            }
            fetchControllers[cardId] = new AbortController();
            let signal = fetchControllers[cardId].signal;

            cardElement.innerHTML = `
                <p>Summarizing...</p>
                <button class="back-button" onclick="restoreContent('${cardId}', true)">Cancel</button>
            `;

            let formData = new FormData();
            formData.append("file_id", String(fileId));
            formData.append("file_name", String(fileName));
            formData.append("file_mime_type", fileMimeType);
            formData.append("file_source", fileSource);

            fetch('/summarize', {
                method: 'POST',
                body: formData,
                signal: signal 
            })
            .then(response => response.json())
            .then(data => {
                if (!fetchControllers[cardId]) return; 

                if (data.summary) {
                    // Use innerHTML to properly render line breaks and bullets
                    cardElement.innerHTML = `
                        <p>${data.summary}</p>
                        <button class="back-button" onclick="restoreContent('${cardId}', false)">Back</button>
                    `;
                } else {
                    cardElement.innerHTML = `<p>Error: Unable to summarize.</p>`;
                }
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    console.log("Fetch request canceled.");
                } else {
                    console.error('Error:', error);
                    cardElement.innerHTML = `<p>Error: Something went wrong.</p>`;
                }
            })
            .finally(() => {
                delete fetchControllers[cardId];
            });
        }

        function restoreContent(cardId, isCancel) {
            if (originalCardContent[cardId]) {
                document.getElementById(cardId).innerHTML = originalCardContent[cardId];
                delete originalCardContent[cardId];

                if (isCancel && fetchControllers[cardId]) {
                    fetchControllers[cardId].abort();
                    delete fetchControllers[cardId];
                }
            }
        }

        function updateSummarizeButton() {
            let checkboxes = document.querySelectorAll('.email-checkbox');
            let selected = Array.from(checkboxes).some(checkbox => checkbox.checked);
            document.getElementById('summarize-emails-button').style.display = selected ? 'block' : 'none';
        }

        function summarizeSelectedEmails() {
            let selectedEmails = Array.from(document.querySelectorAll('.email-checkbox:checked')).map(cb => cb.value);
            if (selectedEmails.length === 0) return;

            document.getElementById('gmail-card').innerHTML = "<p>Summarizing...</p>";

            fetch('/summarize_emails', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email_ids: selectedEmails })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('gmail-card').innerHTML = `<h2>Gmail Summary</h2><p>${data.summary}</p>`;
            })
            .catch(error => console.error('Error:', error));
        }

    </script>

</head>
<body>
    <script>
        function showDashboard(service) {
            document.getElementById("dashboard").style.display = "block";
            document.querySelector(".logo-container").classList.add("shrink");
            
            // Hide all service cards initially
            document.getElementById("gmail").style.display = "none";
            document.getElementById("drive").style.display = "none";
            document.getElementById("microsoft").style.display = "none";
            document.getElementById("courses").style.display = "none";
            
            // Show only the selected service card
            if (service === 'gmail') {
                document.getElementById("gmail").style.display = "block";
            } else if (service === 'drive') {
                document.getElementById("drive").style.display = "block";
            } else if (service === 'microsoft') {
                document.getElementById("microsoft").style.display = "block";
            } else if (service === 'canvas') {
                document.getElementById("courses").style.display = "grid"; /* Changed to grid */
            }
        }
    </script>


    <h1></h1>
    <div class="logo-container">
        <div class="logo" onclick="showDashboard('gmail')">
            <img src="https://upload.wikimedia.org/wikipedia/commons/7/7e/Gmail_icon_%282020%29.svg" alt="Gmail">
        </div>
        <div class="logo" onclick="showDashboard('drive')">
            <img src="https://upload.wikimedia.org/wikipedia/commons/d/da/Google_Drive_logo.png" alt="Google Drive">
        </div>
        <div class="logo" onclick="showDashboard('microsoft')">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/Microsoft_logo.svg" alt="Microsoft">
        </div>
        <div class="logo" onclick="showDashboard('canvas')">
            <img src="https://www.wabash.edu/images2/technology/canvas.png" alt="Canvas">
        </div>
    </div>
    
    <div class="container" id="dashboard">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search data..." oninput="filterResults()">
            <select id="service-filter" onchange="filterResults()">
                <option value="all">All</option>
                <option value="gmail">Gmail</option>
                <option value="drive">Google Drive</option>
                <option value="microsoft">Microsoft</option>
                <option value="canvas">Canvas</option>
            </select>
        </div>
        <ul id="search-results"></ul>
        
        <div class="card" id="gmail">
            <h2>Gmail Emails</h2>
            <button class="button" id="connect-gmail-btn">Connect Gmail</button>
            <p id="gmail-status">Status: Not Connected</p>
            <div id="gmail-date-selection" style="display: none;">
                <label for="gmail-date">Choose Gmail Date:</label>
                <input type="date" id="gmail-date">
                <button class="button" onclick="chooseGmailDate()">Set Gmail Date</button>
            </div>
            <div class="card" id="gmail-card">
                <h2>Gmails</h2>
                <ul id="email-list"></ul>
            </div>
            <button id="summarize-emails-button" class="button" style="display:none;" onclick="summarizeSelectedEmails()">Summarize Selected</button>
        </div>
            
        <script>
            let originalGmailContent = ""; 
            let gmailFetchController = null; 
        
            function updateSummarizeButton() {
                let checkboxes = document.querySelectorAll('.email-checkbox');
                let selected = Array.from(checkboxes).some(checkbox => checkbox.checked);
                document.getElementById('summarize-emails-button').style.display = selected ? 'block' : 'none';
            }
        
            function summarizeSelectedEmails() {
                let selectedEmails = Array.from(document.querySelectorAll('.email-checkbox:checked')).map(cb => cb.value);
                if (selectedEmails.length === 0) return;
        
                let gmailCard = document.getElementById("gmail-card");
        
                // Save original content
                if (!originalGmailContent) {
                    originalGmailContent = gmailCard.innerHTML;
                }
        
                // Abort any ongoing fetch request
                if (gmailFetchController) {
                    gmailFetchController.abort();
                }
                gmailFetchController = new AbortController();
                let signal = gmailFetchController.signal;
        
                gmailCard.innerHTML = `
                    <p>Summarizing selected emails...</p>
                    <button class="back-button" onclick="restoreGmailContent(true)">Cancel</button>
                `;
        
                fetch('/summarize_emails', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email_ids: selectedEmails }),
                    signal: signal
                })
                .then(response => response.json())
                .then(data => {
                    if (!gmailFetchController) return;
        
                    if (data.summary) {
                        gmailCard.innerHTML = `
                            <h2>Gmail Summary</h2>
                            <p>${data.summary}</p>
                            <button class="back-button" onclick="restoreGmailContent(false)">Back</button>
                        `;
                    } else {
                        gmailCard.innerHTML = `<p>Error: Unable to summarize.</p>`;
                    }
                })
                .catch(error => {
                    if (error.name === 'AbortError') {
                        console.log("Summarization request canceled.");
                    } else {
                        console.error('Error:', error);
                        gmailCard.innerHTML = `<p>Error: Something went wrong.</p>`;
                    }
                })
                .finally(() => {
                    gmailFetchController = null;
                });
            }
        
            function restoreGmailContent(isCancel) {
                let gmailCard = document.getElementById("gmail-card");
        
                if (originalGmailContent) {
                    gmailCard.innerHTML = originalGmailContent;
                    originalGmailContent = "";
                }
        
                if (isCancel && gmailFetchController) {
                    gmailFetchController.abort();
                    gmailFetchController = null;
                }
            }
        </script>            

        <div class="course-container" id="courses">
            {% for course in courses %}
                <div class="course-card" onclick="toggleCourse('{{ course.id }}')">
                    {{ course.name }}
                    <div id="buttons-{{ course.id }}" class="hidden">
                        <button class="button" onclick="fetchContent('{{ course.id }}', 'syllabus')">Syllabus</button>
                        <button class="button" onclick="fetchContent('{{ course.id }}', 'upcoming_assignments')">Upcoming Assignments</button>
                        <button class="button" onclick="fetchContent('{{ course.id }}', 'recent_announcements')">Recent Announcements</button>
                        <div id="content-{{ course.id }}" class="content hidden"></div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="card" id="drive">
            <h2>Google Drive Files</h2>
            <button class="button" id="connect-drive-btn">Connect Google Drive</button>
            <p id="drive-status">Status: Not Connected</p>
            <div id="drive-date-selection" style="display: none;">
                <label for="drive-date">Choose Google Drive Date:</label>
                <input type="date" id="drive-date">
                <button class="button" onclick="chooseDriveDate()">Set Drive Date</button>
            </div>
            <div class="card" id="google-drive-card">
                <h2>Google Drive Files</h2>
                <ul id="google-drive-files"></ul>
            </div>
        </div>
            
        <div class="card" id="microsoft">
            <h2>Microsoft Services</h2>
            <button class="button" id="connect-microsoft-btn">Connect Microsoft</button>
            <p id="microsoft-status">Status: Not Connected</p>
            <div id="microsoft-auth-container" style="display: none;">
                <p>Enter this code: <strong id="user-code"></strong></p>
            </div>
            <button id="check-status-btn" class="button" style="display: none;">Check Status</button>
            <div id="date-selection" style="display: none;">
                <label for="onedrive-date">Choose OneDrive Date:</label>
                <input type="date" id="onedrive-date">
                <button class="button" onclick="chooseDate('onedrive')">Set OneDrive Date</button>
                <label for="outlook-date">Choose Outlook Date:</label>
                <input type="date" id="outlook-date">
                <button class="button" onclick="chooseDate('outlook')">Set Outlook Date</button>
            </div>
            <div class="card">
                <h2>Outlook Summary</h2>
                <div id="outlook-summary">No data yet.</div>
            </div>
            <div class="card" id="onedrive-card">
                <h2>OneDrive Files</h2>
                <ul id="onedrive-files"></ul>
            </div>
        </div>

    </div>

        <script>
            $(document).ready(function() {
                $("#connect-drive-btn").click(function() {
                    $.ajax({
                        url: "/connect_google_drive",
                        type: "POST",
                        success: function(response) {
                            if (response.status === "success") {
                                $("#drive-status").text("Connected to Google Drive ✅").css("color", "green");
                                $("#connect-drive-btn").hide();

                                // Show date selection fields
                                $("#drive-date-selection").show();

                                // Update the file list
                                let filesList = $("#google-drive-files");
                                filesList.empty(); // Clear previous content

                                response.files.forEach(file => {
                                    let listItem = `
                                        <li class="file-container">
                                            <a href="https://drive.google.com/file/d/${file.id}" target="_blank">${file.name}</a>
                                            <button class="summarize-button" 
                                                onclick="summarizeFile(event, '${file.id}', '${file.name}', '${file.mimeType}', 'google_drive', 'google-drive-card')">
                                                Summarize
                                            </button>
                                        </li>
                                    `;
                                    filesList.append(listItem);
                                });
                            } else {
                                $("#drive-status").text("Connection Failed ❌").css("color", "red");
                            }
                        },
                        error: function() {
                            $("#drive-status").text("Connection Error ❌").css("color", "red");
                        }
                    });
                });
            });
            $(document).ready(function() {
                $("#connect-gmail-btn").click(function() {
                    $("#gmail-status").text("Fetching metadata... ⏳").css("color", "orange");

                    $.ajax({
                        url: "/connect_gmail",  // Endpoint for Gmail authentication
                        type: "POST",
                        success: function(response) {
                            if (response.status === "success") {
                                $("#gmail-status").text("Connected to Gmail ✅").css("color", "green");
                                $("#connect-gmail-btn").hide();
                                // Show the date selection fields
                                $("#gmail-date-selection").show();

                                // Update the email list
                                let emails = response.emails;
                                let emailListHtml = "";
                                emails.forEach(email => {
                                    emailListHtml += `<li>
                                                        <input type="checkbox" class="email-checkbox" value="${email.id}" onchange="updateSummarizeButton()">
                                                        <a href="${email.link}" target="_blank">${email.sender} ${email.subject} (${email.date})</a>
                                                    </li>`;
                                });
                                $("#email-list").html(emailListHtml); // Update the Gmail email list
                            } else {
                                $("#gmail-status").text("Connection Failed ❌").css("color", "red");
                            }
                        },
                        error: function() {
                            $("#gmail-status").text("Connection Error ❌").css("color", "red");
                        }
                    });
                });
            });
            $(document).ready(function() {
                $("#connect-microsoft-btn").click(function() {
                    $("#microsoft-status").text("Checking connection... ⏳").css("color", "orange");

                    $.ajax({
                        url: "/fetch_code",
                        type: "POST",
                        success: function(response) {
                            console.log(response);  

                            if (response.status === "pending") {
                                if (response.user_code) {
                                    $("#microsoft-status").text("User authentication required! ⚠️").css("color", "green");
                                    $("#microsoft-auth-container").show();
                                    $("#user-code").text(response.user_code);
                                    $("#check-status-btn")
                                        .text(`Authenticate`)
                                        .css("display", "inline-block")
                                        .off("click")
                                        .click(function() {
                                            window.open(response.verification_url, "_blank"); 
                                            fetchMicrosoftStatus(); 
                                        });
                                }
                            } else if (response.status === "success") {
                                fetchMicrosoftStatus(); 
                            } else {
                                $("#microsoft-status").text("Error fetching data ❌").css("color", "red");
                            }
                        },
                        error: function() {
                            $("#microsoft-status").text("Connection Error ❌").css("color", "red");
                        }
                    });
                });

                function fetchMicrosoftStatus() {
                    $("#microsoft-status").text("Fetching data from OneDrive & Outlook... ⏳").css("color", "orange");

                    $.ajax({
                        url: "/fetch_onedrive_outlook",
                        type: "POST",
                        success: function(response) {
                            console.log(response);

                            if (response.status === "pending") {
                                $("#microsoft-status").text("Connected ✅").css("color", "green");

                                // Hide authentication elements
                                $("#connect-microsoft-btn").hide();
                                $("#microsoft-auth-container").hide();
                                $("#check-status-btn").hide();

                                // Show date selection fields
                                $("#date-selection").show();

                                // Update Outlook Summary
                                $("#outlook-summary").html(response.outlooks || "No emails found.");

                                // Update OneDrive Files
                                let filesList = $("#onedrive-files");
                                filesList.empty();  

                                response.o_files.forEach(file => {
                                    let listItem = `
                                        <li class="file-container">
                                            ${file[0]} (ID: ${file[1]})
                                            <button class="summarize-button" 
                                                onclick="summarizeFile(event, '${file[1]}', '${file[0]}', '', 'onedrive', 'onedrive-card')">
                                                Summarize
                                            </button>
                                        </li>
                                    `;
                                    filesList.append(listItem);
                                });

                            } else {
                                $("#microsoft-status").text("Error fetching data ❌").css("color", "red");
                            }
                        },
                        error: function() {
                            $("#microsoft-status").text("Error retrieving data ❌").css("color", "red");
                        }
                    });
                }
            });
            function chooseDate(type) {
                let selectedDate = type === 'onedrive' ? $("#onedrive-date").val() : $("#outlook-date").val();

                if (selectedDate) {
                    let dateDifference = calculateDateDifference(selectedDate);
                    
                    let targetElement = type === 'onedrive' ? $("#onedrive-files") : $("#outlook-summary");
                    targetElement.html(`<p style="color: orange;">Fetching ${type.charAt(0).toUpperCase() + type.slice(1)} data... ⏳</p>`);

                    $.ajax({
                        url: "/fetch_onedrive_outlook",
                        type: "POST",
                        data: {
                            cutoff_days: dateDifference,
                            type: type  
                        },
                        success: function(response) {
                            console.log("Fetched Microsoft Data:", response); // Debugging

                            let microsoftData = [];

                            if (type === "outlook") {
                                let outlookData = response.outlooks || "<p style='color: gray;'>No recent emails found.</p>";
                                targetElement.html(outlookData);

                                // ✅ Store Outlook Emails in Search Data
                                if (response.outlooks && response.outlooks.length > 0) {
                                    response.outlooks.forEach(email => {
                                        microsoftData.push({
                                            service: 'microsoft',
                                            text: `Outlook: ${email.subject}`,
                                            link: null
                                        });
                                    });
                                }
                            } else if (type === "onedrive") {
                                let filesList = $("#onedrive-files");
                                filesList.empty();

                                if (response.o_files && response.o_files.length > 0) {
                                    response.o_files.forEach(file => {
                                        let listItem = `
                                            <li class="file-container">
                                                ${file[0]} (ID: ${file[1]})
                                                <button class="summarize-button" 
                                                    onclick="summarizeFile(event, '${file[1]}', '${file[0]}', '', 'onedrive', 'onedrive-card')">
                                                    Summarize
                                                </button>
                                            </li>
                                        `;
                                        filesList.append(listItem);

                                        // ✅ Store OneDrive Files in Search Data
                                        microsoftData.push({
                                            service: 'microsoft',
                                            text: `OneDrive: ${file[0]}`,
                                            link: null
                                        });
                                    });
                                } else {
                                    filesList.append("<li style='color: gray;'>No recent OneDrive files found.</li>");
                                }
                            }

                            // ✅ Store all fetched Microsoft data in `allData`
                            if (microsoftData.length > 0) {
                                storeData('microsoft', microsoftData);
                            }
                        },
                        error: function() {
                            console.error("Error retrieving data");
                            targetElement.html(`<p style="color: red;">Error retrieving ${type} data ❌</p>`);
                        }
                    });
                }
            }

            function chooseDriveDate() {
                let selectedDate = $("#drive-date").val();
                if (!selectedDate) return;

                let dateDifference = calculateDateDifference(selectedDate);
                $("#google-drive-files").html(`<p style="color: orange;">Fetching Google Drive data... ⏳</p>`);

                $.ajax({
                    url: "/connect_google_drive",
                    type: "POST",
                    data: { num_days: dateDifference },
                    success: function(response) {
                        console.log("Fetched Drive Files:", response); // Debugging

                        let filesList = $("#google-drive-files");
                        filesList.empty(); // Clear previous content

                        if (response.files && response.files.length > 0) {
                            let driveData = response.files.map(file => ({
                                text: file.name,
                                link: `https://drive.google.com/file/d/${file.id}`
                            }));

                            storeData('drive', driveData); // ✅ Store files AFTER they are fetched

                            response.files.forEach(file => {
                                let listItem = `
                                    <li class="file-container">
                                        <a href="https://drive.google.com/file/d/${file.id}" target="_blank">${file.name}</a>
                                        <button class="summarize-button" 
                                            onclick="summarizeFile(event, '${file.id}', '${file.name}', '${file.mimeType}', 'google_drive', 'google-drive-card')">
                                            Summarize
                                        </button>
                                    </li>
                                `;
                                filesList.append(listItem);
                            });
                        } else {
                            filesList.append("<li style='color: gray;'>No recent Google Drive files found.</li>");
                        }
                    },
                    error: function() {
                        console.error("Error retrieving Google Drive data");
                        $("#google-drive-files").html(`<p style="color: red;">Error retrieving Google Drive data ❌</p>`);
                    }
                });
            }


            function toggleCourse(courseId) {
                $("#buttons-" + courseId).toggleClass("hidden");
            }

            function fetchContent(courseId, contentType) {
                $.ajax({
                    url: "/course_details",
                    type: "POST",
                    contentType: "application/json",  // ✅ Specify JSON content type
                    data: JSON.stringify({ course_id: courseId, content_type: contentType }),
                    success: function (data) {
                        if (data.content) {
                            // Injecting the HTML content directly without wrapping it in <p> tags.
                            $("#content-" + courseId).html(data.content).removeClass("hidden");

                            storeData('canvas', [{ text: `Canvas: ${data.content}`, link: null }]); // Store Canvas content
                        } else {
                            $("#content-" + courseId).html("<p>Error fetching data.</p>").removeClass("hidden");
                        }
                    },
                    error: function () {
                        $("#content-" + courseId).html("<p>Failed to fetch data.</p>").removeClass("hidden");
                    }
                });
            }


            function chooseGmailDate() {
                let selectedDate = $("#gmail-date").val();
                if (!selectedDate) return;

                let dateDifference = calculateDateDifference(selectedDate);
                $("#email-list").html(`<p style="color: orange;">Fetching Gmail data... ⏳</p>`);

                $.ajax({
                    url: "/connect_gmail",
                    type: "POST",
                    data: { num_days: dateDifference },
                    success: function(response) {
                        console.log("Fetched Emails:", response); // Debugging

                        let emailList = $("#email-list");
                        emailList.empty(); // Clear previous content

                        if (response.emails && response.emails.length > 0) {
                            let gmailData = response.emails.map(email => ({
                                text: `${email.sender} - ${email.subject}`,
                                link: email.link
                            }));

                            storeData('gmail', gmailData); // ✅ Store emails AFTER they are fetched

                            response.emails.forEach(email => {
                                let listItem = `
                                    <li>
                                        <input type="checkbox" class="email-checkbox" value="${email.id}" onchange="updateSummarizeButton()">
                                        <a href="${email.link}" target="_blank">${email.sender} ${email.subject} (${email.date})</a>
                                    </li>
                                `;
                                emailList.append(listItem);
                            });
                        } else {
                            emailList.append("<li style='color: gray;'>No recent Gmail emails found.</li>");
                        }
                    },
                    error: function() {
                        console.error("Error retrieving Gmail data");
                        $("#email-list").html(`<p style="color: red;">Error retrieving Gmail data ❌</p>`);
                    }
                });
            }


            function calculateDateDifference(selectedDate) {
                let today = new Date();
                let chosenDate = new Date(selectedDate);
                let timeDiff = today - chosenDate;  // Difference in milliseconds
                let dayDiff = Math.max(Math.floor(timeDiff / (1000 * 3600 * 24)), 0);  // Ensure non-negative
                return dayDiff;
            }

            let allData = []; // Global array to store all fetched data for search

            // Function to store data when services fetch new results
            function storeData(service, dataList) {
                console.log(`Storing data for ${service}:`, dataList); // Debugging log

                dataList.forEach(item => {
                    allData.push({
                        service: service, 
                        text: item.text || item.name || item.subject || "",  // Ensure text is always assigned
                        link: item.link || null, 
                    });
                });

                console.log("Updated allData:", allData); // Check if data is being added
            }


            function filterResults() {
                let query = document.getElementById('search-input').value.toLowerCase();
                let filter = document.getElementById('service-filter').value;
                let resultsContainer = document.getElementById('search-results');
                
                // ✅ Clear search results if input is empty
                if (query.trim() === "") {
                    resultsContainer.innerHTML = "";
                    return;
                }

                resultsContainer.innerHTML = ''; // Clear previous results

                let filteredData = allData.filter(item =>
                    (filter === "all" || item.service === filter) &&
                    item.text.toLowerCase().includes(query)
                );

                if (filteredData.length === 0) {
                    resultsContainer.innerHTML = "<li class='search-result-item'>No results found.</li>";
                    return;
                }

                filteredData.forEach(item => {
                    let listItem = document.createElement('li');
                    listItem.classList.add('search-result-item');

                    let serviceTag = `<span class="service-tag">(${item.service})</span> `; // Service tag to display

                    // 🔍 Highlighting the matched text
                    const regex = new RegExp(`(${query})`, 'gi');  // Case-insensitive matching
                    const highlightedText = item.text.replace(regex, '<mark>$1</mark>');  // Wrap matches with <mark> tag

                    if (item.link) {
                        listItem.innerHTML = `${serviceTag}<a href="${item.link}" target="_blank">${highlightedText}</a>`;
                    } else {
                        listItem.innerHTML = `${serviceTag}${highlightedText}`;
                    }

                    resultsContainer.appendChild(listItem);
                });
            }

        </script>        

</body>
</html>